# 图解HTTP

##1. 了解Web

###1.1 三次握手

1. 发送端标有SYN(synchronize)标志的数据给接收端
2. 接收端回传一个带有SYN和ACK(acknowledgement)标志的数据包以示传达成功.
3. 发送端再回传带有ACK标志的数据包,结束.

###1.2 请求报文 & 响应报文

![请求报文](QQ20160114-0.png)

其实请求报文也有主体,一般当方式为POST,参数就作为请求报文的主体,首部和主体靠空行(CR回车符+LF换行符)相隔开.

1. 请求报文的起始行叫请求行: 包含请求方法 请求URI HTTP版本.
2. 响应报文的起始行叫状态行: 包含HTTP版本 响应结果状态码 原因短语.
3. 首部字段: 表示请求/响应的各种条件和属性的各类首部.一般的首部有通用首部,请求首部,响应首部和实体首部.
4. 其他: HTTP的RFC里未定义的首部(Cookie等)

###1.3 报文主体和实体主体

1. 报文: 是HTTP通信中的基本单位,由8位组字节流组成,通过HTTP通信传输.用于传输请求/响应的实体主体.
2. 实体: 作为请求或响应的有效载荷数据(补充项)被传输,其内容由实体首部和实体主体组成.

通常,报文主体等于实体字体,只有当传输中进行编码操作时,实体主体发生变化,才导致它和报文主体产生差异.

###1.4 压缩

常用

1. gzip(GNU zip)
2. compress(UNIX系统的标准压缩)
3. deflate(zlib)
4. identity(不进行编码)
5. sdch(Shared Dictionary Compression over HTTP)

笔者网站在Chrome47打开就会显示

    Accept-Encoding:gzip, deflate, sdch

###1.5 分块发送

当编码实体资源未全部传输完成,客户端无法显示请求页面.可以把数据分割为多块,称为分块传输编码,么一块都会用16进制标记块大小,而实体主体的最后一块会用"0(CR+LF)"标记.

HTTP1.1存在一种称为传输编码(Transfer Coding)机制,可以在通信时按某种编码方式传输,但只能作用于分块传输编码中.

###1.6 发送多种数据的多部分对象集合

1. multipart/form-data web表单上传文件时使用

2. multipart-byteranges

    状态码为206

在使用多部分集合时,首部字段都会加上Content-type

###1.7 获取部分内容的范围请求

在执行部分请求时,首部字段Range指定资源的byte范围

1. 获取5001~1000字节: `Range: bytes=5001-10000`
2. 获取5001之后全部:`Range: bytes=5001-`
3. 从一开始到3000和5000-7000字节的多重范围 : `Range:bytes=-3000, 5000-7000`

针对范围请求,返回状态码为206Partial Content,对于多重范围的请求,响应首部字段Content-Type表名multipart/byteranges后返回响应报文.

###1.8 内容协商返回最合适的内容

1. 服务器驱动协商:服务器根据首部字段自动处理
2. 客户端驱动协商:用户从浏览器显示手动选择
3. 透明协商,服务器驱动和客户端驱动各自进行内容协商.


## 2. 状态码

1. 1XX : 接受请求正在处理
2. 2XX : 请求处理成功
3. 3XX : 重定向状态码
4. 4XX : 服务器无法处理请求
5. 5XX : 服务器处理请求错误

详解: 

1. 200 OK 当请求方式不同,返回结果不同,GET请求资源的实体会作为响应返回,HEAD请求资源的实体首部不随报文主体响应返回.
2. 204 No Content 不允许返回任何实体的主题.
3. 206 Partial Content 返回指定资源的一部分请求

---

1. 301 Moved Permanently 永久性重定向
2. 302 Found 临时性重定向
3. 303 See Other 和302类似,不过303表明客户端应当采取GET方法获取资源
4. 304Not Modified表名客户端发送附带条件的请求(If-Math,If-Modified-Since等),服务区允许访问,但请求未满足条件,返回304
5. 307 临时重定向,和302类似,不过大多浏览器不会强迫把POST改为GET

301,302,303作为装潢台吗返回,几乎所有浏览器都会默认把POST改为GET,并删除请求报文内的主题,之后请求会自动重新发送.

---
1. 400 Bad Request:   请求报文存在语法错误,浏览器会对待200一样对待此状态
2. 401 Unauthorized:请求需要通过HTTP认证(BASIC认证/DIGEST认证)等,但若之前进行过一次失败的认证,返回该状态码
3. 403 Foribdden : 无权限访问该资源
4. 404 服务器上没有请求的资源

---

1. 500 Internal Server Error表示服务器执行请求时发生了错误
2. 503 Service Unavailable 表示服务器超负载,无法处理请求.

##3. 与HTTP协作的Web服务器

###3.1 通信数据转发程序:代理 网关 隧道

1. 代理: 是一种有转发功能的应用程序.
    每次经过一个代理服务器时,都会增加Via首部字段以标记经过的合租记信息.
    
    使用代理原因有:是有缓存,对特定网站进行访问控制

    代理有两种基准分类,是否使用缓存/是否修改报文
    
    1. 缓存代理: 会预先将资源的副本缓存到代理服务器上
    2. 透明代理: 不对报文进行任何加工的代理成为透明代理,反之称为非透明代理
    
2. 网关: 网关和代理类似,但是网关能使通信线路上的服务器提供非HTTP服务.
3. 隧道: 可按要求建立一条与其他服务器的通信线路,加密,不会解析HTTP请求.

##4. HTTP首部

HTTP首部字段类型

1. 通用首部字段: 请求报文和响应报文都会使用
2. 请求首部字段: 客户端向服务器请求时使用
3. 响应首部字段: 服务器向客户端请求时使用
4. 实体首部字段: 针对请求报文和响应报文的实体部分使用的首部.

###4.1 通用首部字段

通用首部指:请求报文和响应报文双方都会使用的.

1. Cache-Control:操作缓存机制,可有多个值`,`分割
    
    缓存请求指令

    1. no-cache: 强制向服务器再次验证,可指定特定用户`no-cache=Location`,其实该指令代表不缓存过期的资源,缓存会向源服务器进行有效期确认后处理资源.
    2. no-store: 不缓存请求或响应的任何内容,该指令才是真正的不进行缓存.
    3. max-age=秒: 响应最大的Age值,如果判断缓存资源的缓存时间数值比指定的数值更小,那么客户端接受缓存的资源,另外max-age值为0,那么缓存服务器通常需要将请求转发给源服务器.
    4. max-stale=秒: 接受已过期的响应,如果该指令未指定参数值,无论经过多久,客户端都会接受响应,如果指定了值,即使过期,主要出于max-stale指定时间内,仍旧会被服务器接受.
    5. min-fresh=秒: 期望在指定时间内响应仍有效,要求缓存服务器返回至少还未超过指定时间的缓存资源.
    6. no-transform: 代理不可更改媒体类型
    7. only-if-cached: 从缓存获取资源
    8. cache-extension: 新指令标记(token).
    ---
    缓存响应指令
    
    1. public: 可向任一方提供响应缓存
    2. private: 仅向特定用户返回响应
    3. no-cache: 缓存前必须先确认其有效性
    4. no-store: 不缓存请求或响应的任何内容
    5. no-transform: 代理不可更改媒体类型
    6. must-revalidate: 可缓存但必须再向源服务器进行确认
    7. proxy-revalidate: 要求中间缓存服务器对缓存的响应有效性再进行确认
    8. max-age=秒: 响应最大的Age值,当源服务器设置了该值,缓存服务器将不对资源的有效性再作确认,而max-age数值代表资源保存为缓存的最长时间.HTTP1.1会忽略Expires,而HTTP1.0会忽略max-age,
    9. s-maxage=秒: 公共缓存服务器响应最大的Age值,只适用于多用户使用的公共缓存服务器,设置了该指令后,忽略Expires和max-age.
    10. cache-extension: 新指令标记(token)
    
    
2. 


